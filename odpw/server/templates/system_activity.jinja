<!{% extends "_base.jinja" %}

{% block sidenav %}
            <li class=" text-centered">
                        <a href="/"> 
                            <i class="fa fa-server fa-fw"></i>
                            <p>System</p>
                        </a>
                    </li>
                    <li class=" text-centered">
                        <a href="/portals"> 
                            <i class="fa fa-cubes  fa-fw"></i>
                            <p>Portals</p>
                        </a>
                    </li>
                    <li class="active text-centered">
                        <a href="/activity">
                            <i class="fa fa-cubes  fa-fw"></i>
                            <p>Activity</p>
                        </a>
                    </li>
{% endblock %}
{% block section %}
    <div class="units-row">
        <h2>Portal Watch Activity for snapshot {{snapshot}}</h2>
    </div>
    <div class="units-row">
                <div class="unit-33 card unit-padding">
                    <div class="card_header"><h3 class="text-centered">Fetch Process</h3></div>
                    <div class="card_cnt">
                        <table>
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                    <th>Status</th>
                                    <th>Portals</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="fa fa-spinner fa-spin fa-fw"></i></td>
                                    <td><span class="label label-white width-70 text-right">Running</span></td>
                                    <td><span id="fetch_running" class="btn label label-blue width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa fa-question-circle fa-fw"></i></td>
                                    <td><span class="label label-white width-70 text-right">Missing</span></td>
                                    <td><span id="fetch_missing" class="btn label label-yellow width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa fa-check-square-o fa-fw"></i></td>
                                    <td><span class="label label-white width-70 text-right">Processed</span></td>
                                    <td class="width-20"><span id="fetch_done" class="btn label label-green width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa  fa-exclamation-triangle fa-fw"></i></td>
                                    <td><span class="label label-white width-70 text-right">Failed</span></td>
                                    <td><span id="fetch_failed" class="btn label label-red width-90 text-right"></span></td>
                                </tr>
                            </tbody>
                        </table>
                        
                    </div>
                    <div class="card_footer">
                        <span class="text-centered width-100">{{ '{0:,}'.format(data.dbds)}} datasets inserted</span>
                    </div>
                </div>
                <div class="unit-33 card unit-padding">
                    <div class="card_header"><h3 class="text-centered">Head Lookups</h3></div>
                    <div class="card_cnt">
                        <table>
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                    <th>Status</th>
                                    <th>Portals</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="fa fa-spinner fa-spin fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Running</span></td>
                                    <td><span id="fetch_running" class="btn label label-blue width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa fa-question-circle fa-fw"></i></td>
                                    <td><span class="label label-white width-70 text-right">Missing</span></td>
                                    <td><span id="fetch_missing" class="btn label label-yellow width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa fa-check-square-o fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Processed</span></td>
                                    <td class="width-20"><span id="fetch_done" class="btn label label-green width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa  fa-exclamation-triangle fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Failed</span></td>
                                    <td><span id="fetch_failed" class="btn label label-red width-90 text-right"></span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                    <div class="card_footer">
                        <span class="width-100">{{  '{0:,}'.format(data.dbresproc) }} of {{ '{0:,}'.format(data.dbres)}} resources</span>
                    </div>
                </div>
                <div class="unit-30  card unit-padding">
                    <div class="card_header"><h3 class="text-centered">Quality Assessment</h3></div>
                    <div class="card_cnt">
                        <table>
                            <thead>
                                <tr>
                                    <th>&nbsp;</th>
                                    <th>Status</th>
                                    <th>Portals</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr>
                                    <td><i class="fa fa-spinner fa-spin fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Running</span></td>
                                    <td><span id="fetch_running" class="btn label label-blue width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa fa-question-circle fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Missing</span></td>
                                    <td><span id="fetch_missing" class="btn label label-yellow width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa fa-check-square-o fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Processed</span></td>
                                    <td class="width-20"><span id="fetch_done" class="btn label label-green width-90 text-right"></span></td>
                                </tr>
                                <tr>
                                    <td><i class="fa  fa-exclamation-triangle fa-fw"></i></td>
                                    <td><span class="label label-white width-70">Failed</span></td>
                                    <td><span id="fetch_failed" class="btn label label-red width-90 text-right"></span></td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
            <div class="units-row">
                <div class="unit-100 unit-padding card">
                    <div class="card_header">Portals</div>
                    <div class="cnt">
                        <button id="btn_all" class="btn btn-smaller"><i class="fa fa-pie-chart fa-fw"></i>Show full table</button>
                        <div class="data_table">
                            <table id="sysacttable">
                                <thead>
                                    <tr>
                                        <th>&nbsp;</th>
                                        <th colspan="6">Fetching</th>
                                        <th colspan="2">Head</th>
                                        <th>Quality</th>
                                    </tr>
                                    <tr>
                                        <th>Portal</th>
                                        <th>Running</th>
                                        <th>Done</th>
                                        <th>Failed</th>
                                        <th>Error</th>
                                        <th>start</th>
                                        <th>end</th>
                                        <th>Done</th>
                                        <th>Missing</th>
                                        <th>Done</th>
                                    </tr>
                                </thead>
                            </table>
                        </div>
                    </div>
                    <div class="card_footer">

                    </div>
                </div>
            </div>          

 
                 
      
{% endblock %}

{% block pageScripts %}
 <script>
     
     
     var data = {{ data | tojson|safe }};
     console.log("SERVER DATA")
     console.log(data)
     
     function resetTable(table){
         table.search( '' )
            .columns().search( '' )
            .draw();
     }
     
     function showRows(table, colID, show){
         resetTable(table)
        table.column(colID).search('true').draw()
        table.columns( ).visible( false );
        table.columns( show ).visible( true );
        
     }
     
 $(document).ready(function() {
     var t_sysacttable=$('#sysacttable').DataTable();
     data.portalactivitylist.forEach(function(item){
        t_sysacttable.row.add([item.pid, 
                               item.fetch_running, 
                               item.fetch_done, 
                               item.fetch_failed, 
                               item.fetch_error, 
                               item.fetch_start, 
                               item.fetch_end,
                               item.head_done,
                               item.head_missing, 
                               item.quality_done]);
    }); 
     t_sysacttable.draw();
    $('#fetch_done').click(function() {
         showRows(t_sysacttable, 2, [0,6])
    }); 
    $('#fetch_running').click(function() {
        showRows(t_sysacttable, 1, [0,5])
    });
    $('#fetch_failed').click(function() {
         showRows(t_sysacttable, 3, [0,4])
    });
     
      $('#btn_all').click(function() {
        resetTable(t_sysacttable)
        t_sysacttable.columns().visible( true );
      })
     
     
     for( var k in data.portalactivitysummary){
         console.log(k)
         console.log(data.portalactivitysummary[k])
         $('#'+k).text(data.portalactivitysummary[k])
     }
})
    
 </script>
{% endblock %}